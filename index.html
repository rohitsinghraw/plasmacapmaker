<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Plasma Cap Maker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <style>
    body {
      font-family: 'Comic Sans MS', sans-serif;
    }
    #draggable-cap {
      cursor: move;
      touch-action: none;
      position: absolute;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #draggable-cap img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      pointer-events: none;
    }
    .resize-handle {
      width: 10px;
      height: 10px;
      background-color: #3b82f6;
      border: 2px solid white;
      border-radius: 50%;
      position: absolute;
      z-index: 10;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
    }
    .resize-box-outline {
      border: 1.5px dashed #3b82f6;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 5;
    }
  </style>
</head>
<body class="bg-green-100 min-h-screen flex items-center justify-center p-6">

  <div class="bg-white rounded-2xl shadow-xl p-6 flex flex-col md:flex-row gap-6 w-full max-w-5xl">
    <!-- Left -->
    <div class="flex-1 flex flex-col items-center gap-4">
      <h1 class="text-3xl font-bold text-orange-500">üß¢ Plasma Cap Maker</h1>

      <input type="file" accept="image/*" onchange="previewImage(event)" class="mb-2 text-sm" />

      <div id="canvas-container" class="relative w-[300px] h-[300px] border-2 border-dashed border-gray-400 rounded-md overflow-hidden bg-gray-100">
        <img id="uploaded-image" class="absolute top-0 left-0 w-full h-full object-cover" />
      </div>

      <button onclick="downloadImage()" class="bg-orange-500 hover:bg-orange-600 transition text-white px-6 py-2 rounded-full shadow-md mt-2">
        ‚¨áÔ∏è Download Image
      </button>
    </div>

    <!-- Right -->
    <div class="w-full md:w-48 flex flex-col items-center gap-4">
      <h2 class="text-xl font-semibold text-orange-600">Choose a Cap</h2>
      <div class="flex flex-col gap-4">
        <img src="hat.png" alt="hat1" onclick="selectCap('hat.png')" class="w-20 h-20 border-4 border-transparent hover:border-orange-400 transition cursor-pointer rounded-xl shadow">
        <img src="hat2.png" alt="hat2" onclick="selectCap('hat2.png')" class="w-20 h-20 border-4 border-transparent hover:border-orange-400 transition cursor-pointer rounded-xl shadow">
      </div>
    </div>
  </div>

  <script>
    let currentCap = null;

    function previewImage(event) {
      const file = event.target.files[0];
      const img = document.getElementById('uploaded-image');
      img.src = URL.createObjectURL(file);
      img.onload = () => makeImageInteractable();
    }

    function makeImageInteractable() {
      const img = document.getElementById('uploaded-image');
      img.setAttribute('data-x', 0);
      img.setAttribute('data-y', 0);

      interact(img)
        .draggable({
          modifiers: [interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })],
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            }
          }
        })
        .resizable({
          edges: { left: true, right: true, bottom: true, top: true },
          listeners: {
            move(event) {
              const target = event.target;
              const { width, height } = event.rect;
              target.style.width = `${width}px`;
              target.style.height = `${height}px`;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.deltaRect.left;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.deltaRect.top;
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            }
          },
          modifiers: [
            interact.modifiers.restrictEdges({ outer: 'parent' }),
            interact.modifiers.restrictSize({ min: { width: 100, height: 100 }, max: { width: 500, height: 500 } })
          ],
          inertia: true
        });
    }

    function addHandles(target) {
      const positions = [
        ['top', 'left'], ['top', 'center'], ['top', 'right'],
        ['middle', 'left'], ['middle', 'right'],
        ['bottom', 'left'], ['bottom', 'center'], ['bottom', 'right']
      ];
      target.querySelectorAll('.resize-handle').forEach(h => h.remove());
      positions.forEach(([v, h]) => {
        const dot = document.createElement('div');
        dot.className = 'resize-handle';
        dot.style.top = v === 'top' ? '0%' : v === 'middle' ? '50%' : '100%';
        dot.style.left = h === 'left' ? '0%' : h === 'center' ? '50%' : '100%';
        dot.style.transform = 'translate(-50%, -50%)';
        target.appendChild(dot);
      });
    }

    function selectCap(capImagePath) {
      const container = document.getElementById('canvas-container');
      if (currentCap) {
        container.removeChild(currentCap);
        currentCap = null;
      }

      const cap = document.createElement('div');
      cap.id = 'draggable-cap';
      cap.className = 'top-1/4 left-1/4 w-32 h-20';
      cap.innerHTML = `<img src="${capImagePath}" alt="cap" /><div class="resize-box-outline"></div>`;
      container.appendChild(cap);
      currentCap = cap;

      addHandles(cap);
      makeInteractable(cap);
    }

    function makeInteractable(cap) {
      interact(cap)
        .draggable({
          modifiers: [interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true })],
          listeners: {
            move(event) {
              const target = event.target;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
            }
          }
        })
        .resizable({
          edges: { left: true, right: true, bottom: true, top: true },
          listeners: {
            move(event) {
              const target = event.target;
              const { width, height } = event.rect;
              target.style.width = `${width}px`;
              target.style.height = `${height}px`;
              const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.deltaRect.left;
              const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.deltaRect.top;
              target.style.transform = `translate(${x}px, ${y}px)`;
              target.setAttribute('data-x', x);
              target.setAttribute('data-y', y);
              addHandles(target);
            }
          },
          modifiers: [
            interact.modifiers.restrictEdges({ outer: 'parent' }),
            interact.modifiers.restrictSize({ min: { width: 50, height: 50 }, max: { width: 500, height: 500 } })
          ],
          inertia: true
        })
        .on('resizestart', event => {
          addHandles(event.target);
        });
    }

    function downloadImage() {
      const original = document.getElementById('canvas-container');
      const cap = currentCap;

      const clone = original.cloneNode(true);
      const capClone = clone.querySelector('#draggable-cap');

      if (cap && capClone) {
        const x = parseFloat(cap.getAttribute('data-x')) || 0;
        const y = parseFloat(cap.getAttribute('data-y')) || 0;
        capClone.style.left = `${cap.offsetLeft + x}px`;
        capClone.style.top = `${cap.offsetTop + y}px`;
        capClone.style.transform = 'none';
        capClone.style.position = 'absolute';
        capClone.querySelectorAll('.resize-handle, .resize-box-outline').forEach(el => el.remove());
      }

      const imgClone = clone.querySelector('#uploaded-image');
      if (imgClone) {
        const x = parseFloat(imgClone.getAttribute('data-x')) || 0;
        const y = parseFloat(imgClone.getAttribute('data-y')) || 0;
        imgClone.style.left = `${imgClone.offsetLeft + x}px`;
        imgClone.style.top = `${imgClone.offsetTop + y}px`;
        imgClone.style.transform = 'none';
        imgClone.style.position = 'absolute';
      }

      clone.style.position = 'fixed';
      clone.style.top = '-10000px';
      document.body.appendChild(clone);

      html2canvas(clone, { backgroundColor: '#ffffff', useCORS: true, allowTaint: true }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'plasma-cap.jpg';
        link.href = canvas.toDataURL('image/jpeg', 0.95);
        link.click();
        document.body.removeChild(clone);
      }).catch(err => {
        console.error('Download failed', err);
        alert('Something went wrong while downloading.');
        document.body.removeChild(clone);
      });
    }
  </script>

</body>
</html>
